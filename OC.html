<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cercle de Lecture</title>
  <style>
    body {
      background: linear-gradient(135deg, #e0f7fa, #e1f5fe);
      color: #003344;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      border: 2px solid #d1e7dd;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.8s ease-in-out;
    }

    h2, h3, h4, label {
      color: #0d6efd;
      font-family: 'Comic Sans MS', cursive;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      margin-bottom: 15px;
      border-radius: 10px;
      border: 1px solid #ced4da;
      font-size: 16px;
      background-color: #f0f9ff;
    }

    button {
      margin-top: 10px;
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      background-color: #0d6efd;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease-in-out;
      margin-right: 10px;
    }

    button:hover {
      background-color: #198754;
      transform: scale(1.05);
    }

    .hidden {
      display: none;
    }

    #student-message {
      background-color: #fff3cd;
      border: 2px dashed #ffc107;
      padding: 15px;
      border-radius: 10px;
      color: #856404;
      margin-bottom: 20px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table, th, td {
      border: 1px solid #dee2e6;
    }

    th, td {
      padding: 12px;
      text-align: left;
    }

    .notif-area {
      text-align: right;
      font-size: 18px;
      margin-bottom: 20px;
    }

    .completed {
      background-color: #d4ffd4;
    }

    ul {
      padding-left: 20px;
    }

    ul li {
      margin-bottom: 5px;
    }

    #book-table h4 {
      background-color: #aed581;
      padding: 10px;
      border-radius: 8px;
      color: #1b5e20;
      margin-top: 20px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-toggle {
      background-color: #6c757d;
      margin-bottom: 15px;
    }

    .section-toggle:hover {
      background-color: #5a6268;
    }

    .section-content {
      margin-top: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #dee2e6;
    }
  </style>
</head>
<body>
  <div class="container" id="login-section">
    <h2>Connexion</h2>
    <label>Es-tu un √©l√®ve ou un professeur ?</label>
    <select id="role" onchange="showLoginForm()">
      <option value="">-- Choisir --</option>
      <option value="eleve">√âl√®ve</option>
      <option value="prof">Professeur</option>
    </select>
    <div class="hidden" id="login-form">
      <label>Identifiant</label>
      <input id="username" type="text"/>
      <label>Mot de passe</label>
      <input id="password" type="password"/>
      <button onclick="login()">Se connecter</button>
    </div>
  </div>

  <div class="container hidden" id="student-section">
    <h3 id="student-welcome"></h3>
    <div id="student-message" class="hidden"></div>
    <label for="book">Choisir un livre</label>
    <select id="book" onchange="updateRoles()"></select>
    <label for="roleChoice">Choisir un r√¥le</label>
    <select id="roleChoice"></select>
    <button onclick="enregistrerRole()">Valider</button>
    <button onclick="voirHistorique()">Voir mon historique</button>
    <div class="hidden" id="historique-eleve"></div>
  </div>

  <div class="container hidden" id="professor-section">
    <div class="notif-area">
      <span>üîî Notifications : </span><span id="notif-count">0</span>
    </div>

    <button class="section-toggle" onclick="toggleSection('agenda-section')">üóìÔ∏è Agenda</button>
    <div id="agenda-section" class="hidden section-content">
      <label for="agenda-text">√âcris l'agenda ici :</label>
      <textarea id="agenda-text" rows="4"></textarea>
      <button onclick="saveAgenda()">üíæ Sauvegarder</button>
      <div id="agenda-display" style="margin-top:20px;"></div>
    </div>

    <button class="section-toggle" onclick="toggleSection('message-section')">‚úâÔ∏è Messages</button>
    <div id="message-section" class="hidden section-content">
      <label>√Ä (identifiant √©l√®ve)</label>
      <input id="msg-to" type="text" placeholder="ex: celinefawaz"/>
      <label>Message</label>
      <textarea id="msg-text" placeholder="Tape ton message..."></textarea>
      <label>Du</label>
      <input id="msg-start" type="date"/>
      <label>Au</label>
      <input id="msg-end" type="date"/>
      <button onclick="sendMessage()">Envoyer</button>
      <div style="margin-top:20px;">
        <h4>üìã Messages envoy√©s :</h4>
        <ul id="sent-messages"></ul>
      </div>
    </div>

    <h3>Tableau de gestion (Professeur)</h3>
    <button onclick="voirHistoriqueTous()">Voir tout l'historique</button>
    <button onclick="exportHistorique('pdf')">üìÑ Exporter en PDF</button>
    <button onclick="exportHistorique('excel')">üìä Exporter en Excel</button>
    <button id="clear-history-button" onclick="clearStudentHistoryPrompt()">üßπ Effacer l'historique d'un √©l√®ve</button>

    <div id="book-table"></div>
  </div>

<script>
// === Global Variables ===
const roles = ["Animateur", "Ma√Ætre des mots", "Ma√Ætre des liens", "Ma√Ætre des passages"];
const books = [
  "La belle des eaux", "Les petites reines", "Mes parents sont dans ma classe",
  "Niin", "JEfferson", "Trefle d or", "Le fermier Gill", "Les 2 bossus", "Le journal d une grosse patate",
  "La belle aux cheveux d or", "Reves amers", "Un drole d ange gardien", "Panique dans la mythologie",
  "Mon p√®re est une saucisse", "Les cousins Karlson", "T√©l√©maque", "L'enfant loup", "Tobie Lolness",
  "Dieux et h√©ros des romains", "Theo", "6e pire ann√©e", "Swimming Ace", "L'enfant oc√©an",
  "La jeune fille", "Mimsi Pocket", "153 jours en hiver", "La mal√©diction du corbeau",
  "Le voyage inspir√©", "Slam Dunk", "Le faucon d√©nich√©", "Le myst√®re D√©dale", "Fils de sorci√®re", 
  "Dans le grand bain", "Une incroyable histoire", "La 6eme", "Hunter X Hunter", "Charlemagne", 
  "Ath√©na", "L'Ile sous la mer"
];

const teacherAccounts = {
  "omarc": "ohc",
  "mllelagarrigue": "Mlle.VLagarrigue"
};

const studentAccounts = {
  "celinefawaz": "cfT8x3", "clarakaram": "ckL7z9", "ezelkhocheich": "ekW2f5", "firashusseini": "fhN5d2",
  "jadbaker": "jbR9t6", "joudemoubayed": "jmA3q1", "joyboualwan": "jbK6y8", "karimbounassar": "kbP4g7",
  "karimricha": "krZ3x6", "kinanhajjar": "khU7e2", "lamarbsat": "lbV2m5", "leasoubra": "lsY8r3",
  "mariakabalan": "mkF9d1", "maryasanyoura": "msH2z4", "miaramadan": "mrT7p6", "mohamadkojo": "BonjourP2W",
  "nourazohbi": "nzJ5t9", "omarchaar": "ocG6b2", "rayajamal": "rjX3n7", "rayankarimeh": "rkE8y4",
  "raihammoud": "rhA2c3", "roysaghir": "rsU6d5", "samanajjar": "snM7x1", "samifayad": "sfL4t2",
  "samirakkadwattar": "sawP9f8", "sirinebetto": "sbQ1e6", "talalkantar": "tkD3z7"
};

const studentFullNames = {
  "celinefawaz": "Celine Fawaz", "clarakaram": "Clara Karam", "ezelkhocheich": "Ezel Khocheich",
  "firashusseini": "Firas Husseini", "jadbaker": "Jad Baker", "joudemoubayed": "Joude Moubayed",
  "joyboualwan": "Joy Bou Alwan", "karimbounassar": "Karim Bou Nassar", "karimricha": "Karim Richa",
  "kinanhajjar": "Kinan Hajjar", "lamarbsat": "Lamar Bsat", "leasoubra": "Lea Soubra",
  "mariakabalan": "Maria Kabalan", "maryasanyoura": "Marya Sanyoura", "miaramadan": "Mia Ramadan",
  "mohamadkojo": "Mohamad Kojo", "nourazohbi": "Noura Zohbi", "omarchaar": "Omar Chaar",
  "rayajamal": "Raya Jamal", "rayankarimeh": "Rayan Karimeh", "raihammoud": "Ra√Ø Hammoud",
  "roysaghir": "Roy Saghir", "samanajjar": "Sama Najjar", "samifayad": "Sami Fayad",
  "samirakkadwattar": "Samir Akkad Wattar", "sirinebetto": "Sirine Betto", "talalkantar": "Talal Kantar"
};

const BIN_ID = "681cc2988960c979a59593c4";
const API_KEY = "$2a$10$e8COjJNqV/ReJs5XiIW7aOntP2QEh3F8EDXCeUmx4oMyRzg2NHobm";

// === Login Functions ===
function showLoginForm() {
  document.getElementById("login-form").classList.remove("hidden");
}

function login() {
  const role = document.getElementById("role").value;
  const user = document.getElementById("username").value.trim().toLowerCase();
  const pass = document.getElementById("password").value.trim();

  if (role === "prof" && teacherAccounts[user] === pass) {
    document.getElementById("login-section").classList.add("hidden");
    document.getElementById("professor-section").classList.remove("hidden");
    if (user === "mllelagarrigue") {
      document.getElementById("clear-history-button").style.display = "none";
    }
    loadOnlineData((data) => {
      localStorage.setItem("cercleData", JSON.stringify(data));
      afficherTableau();
      updateNotif();
      loadAgenda();
      loadMessages();
    });
  } else if (role === "eleve" && studentAccounts[user] === pass) {
    localStorage.setItem("currentStudent", user);
    document.getElementById("login-section").classList.add("hidden");
    document.getElementById("student-section").classList.remove("hidden");
    document.getElementById("student-welcome").innerText = "Bonjour " + studentFullNames[user];
    loadOnlineData((data) => {
      localStorage.setItem("cercleData", JSON.stringify(data));
      loadBooks();
      updateRoles();
      showStudentMessage(user);
      
      const allRoles = data.filter(e => e.student === user).map(e => e.role);
      const uniqueRoles = [...new Set(allRoles)];
      if (uniqueRoles.length === 4) {
        alert("Tu as compl√©t√© les 4 r√¥les. Tu peux maintenant recommencer avec les m√™mes r√¥les sur d'autres livres !");
      }
    });
  } else {
    alert("Identifiants incorrects.");
  }
}

// === Data Management ===
function loadOnlineData(callback) {
  fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
    headers: { "X-Master-Key": API_KEY }
  })
    .then(res => res.json())
    .then(json => callback(json.record.data))
    .catch(() => {
      const localData = JSON.parse(localStorage.getItem("cercleData") || "[]");
      callback(localData);
    });
}

function saveOnlineData(data) {
  fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY
    },
    body: JSON.stringify({ data })
  }).catch(err => console.error("Erreur de sauvegarde en ligne:", err));
}

// === Student Functions ===
function loadBooks() {
  const select = document.getElementById("book");
  select.innerHTML = '<option value="">-- Choisir un livre --</option>';
  books.forEach(book => {
    const option = document.createElement("option");
    option.value = book;
    option.textContent = book;
    select.appendChild(option);
  });
}

function updateRoles() {
  const book = document.getElementById("book").value;
  const student = localStorage.getItem("currentStudent");
  const data = JSON.parse(localStorage.getItem("cercleData") || "[]");

  const group = data.filter(e => e.book === book);
  const studentRoles = data.filter(e => e.student === student).map(e => e.role);
  const uniqueStudentRoles = [...new Set(studentRoles)];

  let options = '<option value="">-- S√©lectionner --</option>';
  roles.forEach(role => {
    const taken = group.some(e => e.role === role);
    const alreadyDid = studentRoles.includes(role);
    let disable = false;

    if (uniqueStudentRoles.length < 4) {
      disable = taken || alreadyDid;
    } else {
      disable = taken;
    }

    options += `<option value="${role}" ${disable ? 'disabled' : ''}>${role}${disable ? ' ‚ùå' : ''}</option>`;
  });

  document.getElementById("roleChoice").innerHTML = options;
}

function enregistrerRole() {
  const book = document.getElementById("book").value;
  const role = document.getElementById("roleChoice").value;
  const student = localStorage.getItem("currentStudent");
  
  if (!book || !role) return alert("S√©lectionne un livre et un r√¥le.");
  
  let data = JSON.parse(localStorage.getItem("cercleData") || "[]");
  const group = data.filter(e => e.book === book);
  
  if (group.length >= 4) return alert("Ce livre est d√©j√† complet.");
  if (group.find(e => e.role === role)) return alert("Ce r√¥le est d√©j√† pris.");

  const newEntry = { book, role, student, date: new Date().toLocaleDateString() };
  data.push(newEntry);
  localStorage.setItem("cercleData", JSON.stringify(data));
  saveOnlineData(data);
  alert("Ton r√¥le est enregistr√© !");
  updateNotif();
  
  const allRoles = data.filter(e => e.student === student).map(e => e.role);
  const uniqueRoles = [...new Set(allRoles)];
  if (uniqueRoles.length === 4) {
    alert("Tu as compl√©t√© les 4 r√¥les. Tu peux maintenant recommencer avec les m√™mes r√¥les sur d'autres livres !");
  }

  updateRoles();
}

function voirHistorique() {
  const student = localStorage.getItem("currentStudent");
  const data = JSON.parse(localStorage.getItem("cercleData") || "[]");
  const historique = data.filter(e => e.student === student);
  let html = "<h4>Historique :</h4><ul>";
  historique.forEach(e => {
    html += `<li>${e.book} ‚Äì ${e.role} (${e.date})</li>`;
  });
  html += "</ul>";
  document.getElementById("historique-eleve").classList.remove("hidden");
  document.getElementById("historique-eleve").innerHTML = html;
}

// === Professor Functions ===
function afficherTableau() {
  const data = JSON.parse(localStorage.getItem("cercleData") || "[]");
  const grouped = {};
  data.forEach(entry => {
    if (!grouped[entry.book]) grouped[entry.book] = [];
    grouped[entry.book].push(entry);
  });
  
  let html = "";
  for (let livre in grouped) {
    const groupe = grouped[livre];
    const complet = groupe.length >= 4;
    html += `<h4>${livre} ${complet ? "‚úÖ" : ""}</h4>`;
    html += `<table class="${complet ? 'completed' : ''}"><tr><th>√âl√®ve</th><th>R√¥le</th><th>Date</th></tr>`;
    groupe.forEach(e => {
      html += `<tr><td>${studentFullNames[e.student] || e.student}</td><td>${e.role}</td><td>${e.date}</td></tr>`;
    });
    html += `</table>`;
  }
  document.getElementById("book-table").innerHTML = html || "Aucune donn√©e.";
}

function voirHistoriqueTous() {
  const data = JSON.parse(localStorage.getItem("cercleData") || "[]");
  let html = "<h4>Historique complet :</h4><ul>";
  data.forEach(e => {
    html += `<li>${e.student} ‚Äì ${e.book} ‚Äì ${e.role} (${e.date})</li>`;
  });
  html += "</ul>";
  alert(html);
}

function clearStudentHistoryPrompt() {
  const prof = document.getElementById("username").value.trim().toLowerCase();
  if (prof !== "omarc") {
    alert("Veuillez contacter Omar Chaar pour activer ce bouton.");
    return;
  }
  const studentId = prompt("Entrez l'identifiant de l'√©l√®ve √† effacer (ex: celinefawaz)");
  if (!studentId) return;
  let data = JSON.parse(localStorage.getItem("cercleData") || "[]");
  data = data.filter(e => e.student !== studentId);
  localStorage.setItem("cercleData", JSON.stringify(data));
  saveOnlineData(data);
  alert("Historique de l'√©l√®ve supprim√©.");
  afficherTableau();
}

function exportHistorique(format = "pdf") {
  const data = JSON.parse(localStorage.getItem("cercleData") || "[]");
  let content = "√âl√®ve;Livre;R√¥le;Date\n";
  data.forEach(e => {
    content += `${studentFullNames[e.student] || e.student};${e.book};${e.role};${e.date}\n`;
  });

  if (format === "excel") {
    const blob = new Blob(["\uFEFF" + content], { type: "application/vnd.ms-excel" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "historique_cercle.xlsx";
    a.click();
    URL.revokeObjectURL(url);
  }

  if (format === "pdf") {
    const win = window.open("", "", "height=700,width=900");
    win.document.write("<html><head><title>Historique</title><style>table{border-collapse:collapse;width:100%}td,th{border:1px solid #888;padding:8px}</style></head><body>");
    win.document.write("<h2>Historique du Cercle de Lecture</h2><table><tr><th>√âl√®ve</th><th>Livre</th><th>R√¥le</th><th>Date</th></tr>");
    data.forEach(e => {
      win.document.write(`<tr><td>${studentFullNames[e.student] || e.student}</td><td>${e.book}</td><td>${e.role}</td><td>${e.date}</td></tr>`);
    });
    win.document.write("</table></body></html>");
    win.document.close();
    win.print();
  }
}

// === Agenda & Messages ===
function saveAgenda() {
  const content = document.getElementById("agenda-text").value;
  localStorage.setItem("agenda", content);
  loadAgenda();
}

function loadAgenda() {
  const agenda = localStorage.getItem("agenda") || "";
  document.getElementById("agenda-display").innerText = agenda;
}

function sendMessage() {
  const to = document.getElementById("msg-to").value.trim().toLowerCase();
  const msg = document.getElementById("msg-text").value;
  const start = document.getElementById("msg-start").value;
  const end = document.getElementById("msg-end").value;

  if (!to || !msg || !start || !end) return alert("Tous les champs sont requis.");
  
  const messages = JSON.parse(localStorage.getItem("messages") || "[]");
  messages.push({ to, msg, start, end });
  localStorage.setItem("messages", JSON.stringify(messages));
  alert("Message envoy√© !");
  loadMessages();
}

function loadMessages() {
  const messages = JSON.parse(localStorage.getItem("messages") || "[]");
  let html = '';
  messages.forEach(m => {
    html += `<li>√Ä ${m.to}: ${m.msg} (${m.start} ‚ûú ${m.end})</li>`;
  });
  document.getElementById("sent-messages").innerHTML = html;
}

function showStudentMessage(user) {
  const messages = JSON.parse(localStorage.getItem("messages") || "[]");
  const today = new Date().toISOString().split('T')[0];
  const msg = messages.find(m => m.to === user && m.start <= today && m.end >= today);
  if (msg) {
    const box = document.getElementById("student-message");
    box.innerText = msg.msg;
    box.classList.remove("hidden");
    setTimeout(() => box.classList.add("hidden"), 5000);
  }
}

// === UI Helpers ===
function toggleSection(id) {
  const section = document.getElementById(id);
  section.classList.toggle('hidden');
}

function updateNotif() {
  const data = JSON.parse(localStorage.getItem("cercleData") || "[]");
  document.getElementById("notif-count").innerText = data.length;
}

// Initialize
window.addEventListener("DOMContentLoaded", () => {
  loadAgenda();
  loadMessages();
  updateNotif();
});
</script>
</body>
</html>
